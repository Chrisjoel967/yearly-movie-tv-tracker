<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Yearly Movie & TV Tracker</title>

<style>
  body {
    margin: 0;
    font-family: system-ui, Arial;
    background: radial-gradient(1200px 600px at 20% -10%, #1a2340, #0b0f17);
    color: #e8eefc;
  }
  .wrap { max-width: 1000px; margin: auto; padding: 20px; }
  h1 { margin-bottom: 14px; }

  .card {
    background: #11182a;
    border: 1px solid #253357;
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 14px;
  }

  .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  input, select, button {
    background: #0e1526;
    border: 1px solid #2b3a5e;
    color: #e8eefc;
    border-radius: 10px;
    padding: 10px;
  }
  button { cursor: pointer; }
  button:hover { filter: brightness(1.1); }

  .search-wrap { position: relative; flex: 1; }
  #clearSearch {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    font-size: 18px;
    color: #a9b7d6;
    cursor: pointer;
  }

  .results, .list { display: grid; gap: 10px; margin-top: 10px; }
  .item {
    display: grid;
    grid-template-columns: 56px 1fr auto;
    gap: 12px;
    align-items: center;
    background: #0f1729;
    border: 1px solid #23314f;
    border-radius: 14px;
    padding: 10px;
  }
  .poster {
    width: 56px;
    height: 84px;
    border-radius: 10px;
    background: #1b2640;
    object-fit: cover;
  }
  .title { font-weight: 700; }
  .meta { font-size: 12px; color: #a9b7d6; }
  .muted { font-size: 12px; color: #a9b7d6; }

  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }

  .pill {
    border: 1px solid #2b3a5e;
    border-radius: 999px;
    padding: 6px 12px;
    font-size: 13px;
  }
</style>
</head>

<body>
<div class="wrap">
<h1>Yearly Movie & TV Tracker</h1>

<!-- SEARCH -->
<div class="card">
  <div class="row">
    <div class="search-wrap">
      <input id="searchInput" placeholder="Search a movie or TV show…" />
      <button id="clearSearch">✕</button>
    </div>

    <select id="typeFilter">
      <option value="multi">Movies + TV</option>
      <option value="movie">Movies only</option>
      <option value="tv">TV only</option>
    </select>

    <button id="searchBtn">Search</button>
  </div>

  <div class="muted" style="margin-top:8px;">
    Uses TMDB search. Pick a title → add to Watchlist or Watched.
  </div>

  <div id="results" class="results"></div>
</div>

<!-- TOTAL TIME -->
<div class="card">
  <div class="row" style="justify-content:space-between;">
    <div>
      <div class="title">Time Watched (Total)</div>
      <div class="muted">Movies = runtime · TV = episodes × avg runtime</div>
    </div>
    <div id="timeTotal" class="pill">0h 0m</div>
  </div>
</div>

<!-- LISTS -->
<div class="grid">
  <div class="card">
    <div class="title">Watchlist</div>
    <div id="watchlist" class="list"></div>
  </div>

  <div class="card">
    <div class="title">Watched Movies</div>
    <div id="watchedMovies" class="list"></div>

    <div class="title" style="margin-top:14px;">Watched TV Shows</div>
    <div id="watchedTV" class="list"></div>
  </div>
</div>
</div>

<script>
/* ================= CONFIG ================= */
const TMDB_BEARER =
"eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJlOWY5NGVkYTNjMzFmMmQ2NWFjM2Y1OWNmMTBhN2VlNiIsIm5iZiI6MTc3MDUxMTY4MS4wNDQsInN1YiI6IjY5ODdkZDQxNjM5ZGJlZWQwNjhjOGQzYiIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.JjpO38-YZKSOX_PXz9zEYiW4zUDpTlFkwPf4XNIOB74";

const TMDB = "https://api.themoviedb.org/3";
const POSTER = "https://image.tmdb.org/t/p/w154";

/* ================= STORAGE ================= */
const KEY = "yearly_tracker_clean";
let state = JSON.parse(localStorage.getItem(KEY)) || { watchlist: [], watched: [] };
const save = () => localStorage.setItem(KEY, JSON.stringify(state));

/* ================= HELPERS ================= */
const uniq = i => `${i.media_type}:${i.id}`;
const hm = m => `${Math.floor(m/60)}h ${m%60}m`;

async function api(path){
  const r = await fetch(TMDB + path, {
    headers: { Authorization: `Bearer ${TMDB_BEARER}` }
  });
  if (!r.ok) throw new Error("TMDB " + r.status);
  return r.json();
}

/* ================= SEARCH ================= */
const q = document.getElementById("searchInput");
const results = document.getElementById("results");

document.getElementById("searchBtn").onclick = search;
document.getElementById("clearSearch").onclick = () => {
  q.value = "";
  results.innerHTML = "";
  q.focus();
};
q.oninput = () => { if (!q.value.trim()) results.innerHTML = ""; };

async function search(){
  if (!q.value.trim()) return;
  results.innerHTML = `<div class="muted">Searching…</div>`;

  const type = document.getElementById("typeFilter").value;
  const d = await api(`/search/${type}?query=${encodeURIComponent(q.value)}`);
  results.innerHTML = "";

  d.results.slice(0,10).forEach(r => {
    const t = r.media_type || type;
    const title = t === "movie" ? r.title : r.name;
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      ${r.poster_path ? `<img class="poster" src="${POSTER+r.poster_path}">` : `<div class="poster"></div>`}
      <div>
        <div class="title">${title}</div>
        <div class="meta">${t.toUpperCase()} · ${r.vote_average?.toFixed(1) ?? "—"}</div>
      </div>
      <div>
        <button>Add</button>
      </div>
    `;
    div.querySelector("button").onclick = () => addWatched(r, t);
    results.appendChild(div);
  });
}

/* ================= ADD WATCHED ================= */
async function addWatched(r, type){
  if (state.watched.some(i => uniq(i) === `${type}:${r.id}`)) return;

  if (type === "movie") {
    const d = await api(`/movie/${r.id}`);
    state.watched.push({
      id: r.id, media_type: "movie",
      title: r.title, poster: r.poster_path,
      minutes: d.runtime || 0
    });
  } else {
    const d = await api(`/tv/${r.id}`);
    const avg = d.episode_run_time?.[0] || 45;
    state.watched.push({
      id: r.id, media_type: "tv",
      title: r.name, poster: r.poster_path,
      episodes: 1, avg
    });
  }
  save();
  render();
}

/* ================= RENDER ================= */
function render(){
  const wl = document.getElementById("watchlist");
  const wm = document.getElementById("watchedMovies");
  const wt = document.getElementById("watchedTV");

  wl.innerHTML = `<div class="muted">Not used in this version.</div>`;
  wm.innerHTML = "";
  wt.innerHTML = "";

  let total = 0;

  state.watched.forEach(i => {
    const div = document.createElement("div");
    div.className = "item";

    if (i.media_type === "movie") {
      total += i.minutes;
      div.innerHTML = `
        ${i.poster ? `<img class="poster" src="${POSTER+i.poster}">` : `<div class="poster"></div>`}
        <div>
          <div class="title">${i.title}</div>
          <div class="meta">${i.minutes} min</div>
        </div>
        <button onclick="remove('${uniq(i)}')">Remove</button>
      `;
      wm.appendChild(div);
    } else {
      total += i.episodes * i.avg;
      div.innerHTML = `
        ${i.poster ? `<img class="poster" src="${POSTER+i.poster}">` : `<div class="poster"></div>`}
        <div>
          <div class="title">${i.title}</div>
          <div class="meta">${i.episodes} ep × ${i.avg}m</div>
          <input type="number" min="0" value="${i.episodes}" style="width:80px;">
        </div>
        <button onclick="remove('${uniq(i)}')">Remove</button>
      `;
      div.querySelector("input").onchange = e => {
        i.episodes = Math.max(0, +e.target.value);
        save(); render();
      };
      wt.appendChild(div);
    }
  });

  document.getElementById("timeTotal").textContent = hm(total);
}
window.remove = k => {
  state.watched = state.watched.filter(i => uniq(i) !== k);
  save(); render();
};

render();
</script>
</body>
</html>
