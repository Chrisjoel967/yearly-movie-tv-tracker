<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Yearly Movie & TV Tracker</title>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --card2:#fbfcff;
      --border:#dde3f0;
      --border2:#cfd8ee;
      --text:#0f172a;
      --muted:#5b6475;
      --accent:#2563eb;
      --accent2:#1d4ed8;
      --danger:#dc2626;
      --shadow: 0 12px 30px rgba(15,23,42,.08);
      --radius:18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 600px at 20% -10%, #e8efff, var(--bg));
      color:var(--text);
    }

    .wrap{ max-width:1150px; margin:0 auto; padding:18px; }
    h1{ margin:0 0 14px; font-size:40px; letter-spacing:.2px; }

    .card{
      background:linear-gradient(180deg, var(--card2), var(--card));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    input, select, button{
      background:#fff;
      border:1px solid var(--border2);
      color:var(--text);
      border-radius:14px;
      padding:11px 12px;
      font-size:16px;
    }

    button{ cursor:pointer; }
    button:hover{ border-color:var(--accent); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .muted{ color:var(--muted); font-size:13px; }

    /* Top tabs */
    .topTabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin:10px 0 14px;
    }
    .topTab{
      border:1px solid var(--border2);
      background:#fff;
      border-radius:999px;
      padding:10px 14px;
      font-size:14px;
      cursor:pointer;
      user-select:none;
    }
    .topTab.active{
      border-color:var(--accent);
      background:rgba(37,99,235,.08);
      color:var(--accent2);
      font-weight:700;
    }

    /* Search */
    .searchWrap{ position:relative; flex:1; min-width:240px; }
    .searchWrap input{ width:100%; padding-right:48px; }
    .clearX{
      position:absolute; right:10px; top:50%;
      transform:translateY(-50%);
      border:none; background:transparent;
      padding:6px 8px; font-size:20px;
      color:var(--muted);
      line-height:1;
    }

    .section{ display:none; }
    .section.active{ display:block; }

    .results,.list{ display:grid; gap:12px; margin-top:12px; }

    .item{
      position:relative;
      display:grid;
      grid-template-columns: 64px 1fr;
      gap:12px;
      align-items:center;
      background:linear-gradient(180deg, #ffffff, #fbfcff);
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px;
    }

    .posterBtn{
      border:none;
      background:transparent;
      padding:0;
      cursor:pointer;
      width:64px;
      height:96px;
    }
    .poster{
      width:64px; height:96px;
      border-radius:14px;
      object-fit:cover;
      background:#e9eefc;
      border:1px solid var(--border);
    }

    .title{
      font-weight:900;
      font-size:20px;
      line-height:1.1;
      margin:0;
      cursor:pointer;
    }
    .title:hover{ color:var(--accent2); }
    .meta{ color:var(--muted); font-size:13px; margin-top:4px; }

    /* 3-dot menu */
    .kebab{
      position:absolute; top:10px; right:10px;
      width:38px; height:38px;
      border-radius:999px;
      border:1px solid var(--border2);
      background:#fff;
      display:grid; place-items:center;
      font-size:18px;
      cursor:pointer;
    }
    .kebab:hover{ border-color:var(--accent); }

    .menu{
      position:absolute; top:52px; right:10px;
      width:220px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
      z-index:50;
    }
    .menu button{
      width:100%;
      border:none;
      border-bottom:1px solid #eef2ff;
      background:#fff;
      padding:12px 12px;
      text-align:left;
      border-radius:0;
      font-size:14px;
    }
    .menu button:last-child{ border-bottom:none; }
    .menu button:hover{ background:rgba(37,99,235,.07); }
    .menu .dangerItem{ color:var(--danger); }

    /* Small tabs inside cards */
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .tab{
      border:1px solid var(--border2);
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      font-size:14px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color:var(--accent);
      background:rgba(37,99,235,.08);
      color:var(--accent2);
      font-weight:700;
    }

    /* Stats pills */
    .statsRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      margin-top:10px;
    }
    .pill{
      flex:1;
      min-width:160px;
      display:flex; justify-content:center; gap:10px; align-items:center;
      border:1px solid var(--border2);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-size:14px;
      white-space:nowrap;
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background:rgba(15,23,42,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(920px, 100%);
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      max-height: calc(100vh - 28px);
      display:flex;
      flex-direction:column;
    }
    .modalTop{
      display:grid;
      grid-template-columns: 120px 1fr auto;
      gap:14px;
      padding:14px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, #ffffff, #fbfcff);
      position:sticky;
      top:0;
      z-index:10;
    }
    .modalPoster{
      width:120px; height:180px;
      border-radius:16px;
      object-fit:cover;
      background:#e9eefc;
      border:1px solid var(--border);
    }
    .modalTitle{ font-weight:950; font-size:22px; margin:0; }
    .modalMeta{ color:var(--muted); font-size:13px; margin-top:6px; }
    .modalActions{ display:flex; flex-direction:column; gap:10px; }
    .modalActions button{
      border-radius:14px;
      padding:10px 12px;
      font-weight:700;
    }
    .btnPrimary{
      border-color:var(--accent);
      background:rgba(37,99,235,.10);
      color:var(--accent2);
    }
    .btnDanger{
      border-color:rgba(220,38,38,.35);
      background:rgba(220,38,38,.07);
      color:var(--danger);
    }

    .modalBody{
      padding:14px;
      display:grid;
      gap:14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .subCard{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .subTitle{ font-weight:900; margin:0 0 8px; }
    .overview{ color:var(--muted); line-height:1.45; margin:0; }

    /* Horizontal carousel */
    .carousel{
      display:flex;
      gap:12px;
      overflow:auto;
      padding:6px 2px 10px;
      scroll-snap-type:x mandatory;
    }
    .carItem{
      min-width:120px;
      max-width:120px;
      scroll-snap-align:start;
      cursor:pointer;
      user-select:none;
    }
    .carImg{
      width:120px; height:170px;
      border-radius:18px;
      object-fit:cover;
      background:#e9eefc;
      border:1px solid var(--border);
      display:block;
    }
    .carName{
      font-size:13px;
      font-weight:800;
      margin-top:6px;
      line-height:1.2;
    }
    .carRole{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
      line-height:1.2;
    }

    /* Home panel */
    .homeGrid{ display:grid; gap:12px; margin-top:12px; }
    .homeRowTitle{ font-weight:950; font-size:18px; margin:0 0 6px; }
    .homeNote{ margin-top:6px; }

    /* Footer sync card */
    .footerCard{
      margin-top:18px;
    }

    /* Responsive */
    @media (max-width: 900px){
      h1{ font-size:32px; }
    }
    @media (max-width: 540px){
      .wrap{ padding:14px; }
      input,select,button{ font-size:15px; }
      .row > *{ width:100%; }
      .searchWrap{ width:100%; }
      .searchWrap input{ padding-right:54px; }
      .clearX{ right:10px; }
      .modalTop{ grid-template-columns: 90px 1fr; }
      .modalPoster{ width:90px; height:135px; }
      .modalActions{
        grid-column: 1 / -1;
        flex-direction:row;
        flex-wrap:wrap;
      }
      .modalActions button{ flex:1; min-width:140px; }
      .modalActions select{ width:100%; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>Yearly Movie & TV Tracker</h1>

  <!-- Top Tabs -->
  <div class="topTabs" id="topTabs">
    <div class="topTab active" data-section="homeSec">Home</div>
    <div class="topTab" data-section="searchSec">Search</div>
    <div class="topTab" data-section="watchlistSec">Watchlist</div>
    <div class="topTab" data-section="watchedSec">Watched</div>
    <div class="topTab" data-section="peopleSec">People</div>
    <div class="topTab" data-section="statsSec">Stats</div>
  </div>

  <!-- HOME -->
  <div class="section active" id="homeSec">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div style="font-weight:950;font-size:22px;">Recently Added</div>
          <div class="muted homeNote">Last 5 items you added (Watchlist + Watched).</div>
        </div>
      </div>

      <div id="homeRecent" class="homeGrid"></div>
    </div>
  </div>

  <!-- SEARCH -->
  <div class="section" id="searchSec">
    <div class="card">
      <div class="row">
        <div class="searchWrap">
          <input id="searchInput" placeholder="Search titles, actors, or directorsâ€¦" />
          <button class="clearX" id="clearSearch" aria-label="Clear search">âœ•</button>
        </div>

        <select id="searchMode">
          <option value="auto" selected>Auto-detect</option>
          <option value="titles">Titles only</option>
          <option value="people">People only</option>
        </select>

        <select id="typeFilter">
          <option value="multi" selected>Movies + TV</option>
          <option value="movie">Movies only</option>
          <option value="tv">TV only</option>
        </select>

        <button id="searchBtn">Search</button>
      </div>

      <div class="muted" style="margin-top:8px;">
        Auto-detect shows <b>Titles</b> and <b>People</b>. Tap a poster/title for details.
      </div>

      <div id="results" class="results"></div>
    </div>
  </div>

  <!-- WATCHLIST -->
  <div class="section" id="watchlistSec">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div style="font-weight:950;font-size:22px;">Watchlist</div>
        <select id="watchlistSort" style="min-width:200px;">
          <option value="recent" selected>Recently added</option>
          <option value="title">Title (Aâ€“Z)</option>
        </select>
      </div>

      <div class="tabs" id="watchlistTabs">
        <div class="tab active" data-tab="movie">Movies</div>
        <div class="tab" data-tab="tv">TV Shows</div>
      </div>

      <div id="watchlistList" class="list"></div>
    </div>
  </div>

  <!-- WATCHED -->
  <div class="section" id="watchedSec">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div style="font-weight:950;font-size:22px;">Watched</div>
        <select id="watchedSort" style="min-width:200px;">
          <option value="recent" selected>Recently added</option>
          <option value="title">Title (Aâ€“Z)</option>
        </select>
      </div>

      <div class="tabs" id="watchedTabs">
        <div class="tab active" data-tab="movie">Movies</div>
        <div class="tab" data-tab="tv">TV Shows</div>
      </div>

      <div id="watchedList" class="list"></div>
    </div>
  </div>

  <!-- PEOPLE -->
  <div class="section" id="peopleSec">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div style="font-weight:950;font-size:22px;">People (Actors & Directors)</div>
      </div>

      <div class="muted" style="margin-top:6px;">
        Search people, follow them, then view their filmography and add titles to Watchlist/Watched.
      </div>

      <div class="tabs" id="peopleTabs">
        <div class="tab active" data-tab="actors">Actors</div>
        <div class="tab" data-tab="directors">Directors</div>
      </div>

      <div id="peopleList" class="list"></div>
    </div>
  </div>

  <!-- STATS -->
  <div class="section" id="statsSec">
    <div class="card">
      <div style="font-weight:950;font-size:22px;">Year Totals</div>
      <div class="statsRow">
        <div class="pill"><b>Movies</b> <span id="timeMovies">0h 0m</span></div>
        <div class="pill"><b>TV</b> <span id="timeTV">0h 0m</span></div>
        <div class="pill"><b>Total</b> <span id="timeTotal">0h 0m</span></div>
      </div>
      <div class="muted" style="margin-top:10px;">
        Movies = runtime Â· TV = watched episodes Ã— avg episode runtime
      </div>
    </div>
  </div>

  <!-- SYNC STATUS MOVED TO BOTTOM -->
  <div class="card footerCard">
    <div class="row" style="justify-content:space-between;">
      <div class="muted">
        Sync status: <span id="syncStatus">Startingâ€¦</span><br/>
        <span id="debugBox" class="muted">Debug: â€”</span>
      </div>
      <div class="muted">Last saved: <span id="lastSaved">â€”</span></div>
    </div>
  </div>
</div>

<!-- DETAILS MODAL -->
<div class="backdrop" id="detailsBackdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalTop">
      <img id="detailsPoster" class="modalPoster" alt="Poster"/>
      <div>
        <h2 id="detailsTitle" class="modalTitle">Title</h2>
        <div id="detailsMeta" class="modalMeta">â€”</div>
      </div>
      <div class="modalActions">
        <button id="detailsAddWatchlist" class="btnPrimary">+ Watchlist</button>
        <button id="detailsAddWatched" class="btnPrimary">âœ“ Watched</button>

        <select id="detailsRating" title="Your rating" style="min-width:160px;">
          <option value="">Your rating: â€”</option>
          <option value="1">ğŸ¿</option>
          <option value="2">ğŸ¿ğŸ¿</option>
          <option value="3">ğŸ¿ğŸ¿ğŸ¿</option>
          <option value="4">ğŸ¿ğŸ¿ğŸ¿ğŸ¿</option>
          <option value="5">ğŸ¿ğŸ¿ğŸ¿ğŸ¿ğŸ¿</option>
        </select>

        <button id="detailsClose" class="btnDanger">â† Back</button>
      </div>
    </div>

    <div class="modalBody">
      <div class="subCard">
        <div class="subTitle">Overview</div>
        <p id="detailsOverview" class="overview">â€”</p>
      </div>

      <div class="subCard">
        <div class="subTitle">Top Billed Cast</div>
        <div id="castCarousel" class="carousel"></div>
      </div>

      <div class="subCard">
        <div class="subTitle">Directors</div>
        <div id="dirCarousel" class="carousel"></div>
      </div>

      <div class="subCard">
        <div class="subTitle">Similar Titles</div>
        <div id="simCarousel" class="carousel"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const TMDB_BEARER = "eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJlOWY5NGVkYTNjMzFmMmQ2NWFjM2Y1OWNmMTBhN2VlNiIsIm5iZiI6MTc3MDUxMTY4MS4wNDQsInN1YiI6IjY5ODdkZDQxNjM5ZGJlZWQwNjhjOGQzYiIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.JjpO38-YZKSOX_PXz9zEYiW4zUDpTlFkwPf4XNIOB74";
const TMDB_BASE = "https://api.themoviedb.org/3";
const IMG_POSTER = "https://image.tmdb.org/t/p/w342";
const IMG_SMALL  = "https://image.tmdb.org/t/p/w185";

const SUPABASE_URL = "https://bgnvmzvrmavzztplzlcg.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJnbnZtenZybWF2enp0cGx6bGNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NjA3MjEsImV4cCI6MjA4NDUzNjcyMX0.fBqfl2Mk8FX_epBwYJ7dBJl5SwyGQyjVfrfiKsrT-xc";
const SUPA_TABLE = "tracker_state";
const SUPA_ID = "main";

const LOCAL_KEY = "yearly_tracker_synced_cache_v2";

/* ===================== ELEMENTS ===================== */
const elSyncStatus = document.getElementById("syncStatus");
const elLastSaved  = document.getElementById("lastSaved");
const elDebugBox   = document.getElementById("debugBox");

const elHomeRecent = document.getElementById("homeRecent");

const elResults = document.getElementById("results");
const elSearchInput = document.getElementById("searchInput");
const elSearchMode = document.getElementById("searchMode");
const elTypeFilter = document.getElementById("typeFilter");

const elWatchlistList = document.getElementById("watchlistList");
const elWatchedList = document.getElementById("watchedList");
const elPeopleList = document.getElementById("peopleList");

const elTimeMovies = document.getElementById("timeMovies");
const elTimeTV = document.getElementById("timeTV");
const elTimeTotal = document.getElementById("timeTotal");

/* ===================== STATE ===================== */
let state = loadLocalState();
let watchlistTab = "movie";
let watchedTab = "movie";
let peopleTab = "actors";
let watchlistSort = "recent";
let watchedSort = "recent";

let sb = null; // do NOT name this "supabase"
let saveTimer = null;

function debug(msg){ if(elDebugBox) elDebugBox.textContent = "Debug: " + msg; }
function setSyncStatus(msg){ if(elSyncStatus) elSyncStatus.textContent = msg; }
function setLastSaved(ts){
  if(!ts){ elLastSaved.textContent = "â€”"; return; }
  const d = new Date(ts);
  elLastSaved.textContent = d.toLocaleString();
}

function closeAllMenus(){
  document.querySelectorAll("[data-menu]").forEach(m=>m.style.display="none");
}

function loadLocalState(){
  try{
    const s = JSON.parse(localStorage.getItem(LOCAL_KEY));
    return s || baseState();
  }catch{
    return baseState();
  }
}
function saveLocalState(){
  localStorage.setItem(LOCAL_KEY, JSON.stringify(state));
}

function baseState(){
  return {
    watchlist: [],
    watched: [],
    people: {
      actors: [],
      directors: []
    }
  };
}

function migrate(){
  if(!state.people) state.people = { actors: [], directors: [] };
  if(!Array.isArray(state.people.actors)) state.people.actors = [];
  if(!Array.isArray(state.people.directors)) state.people.directors = [];

  state.watchlist = Array.isArray(state.watchlist) ? state.watchlist : [];
  state.watched = Array.isArray(state.watched) ? state.watched : [];

  for(const x of state.watchlist){
    if(typeof x.added_at !== "number") x.added_at = Date.now();
  }
  for(const x of state.watched){
    if(typeof x.added_at !== "number") x.added_at = Date.now();
    if(!("rating" in x)) x.rating = null;
    if(x.media_type === "tv"){
      if(!x.seasons_watched) x.seasons_watched = {};
      if(!x.seasons_meta) x.seasons_meta = {};
      if(typeof x.avg_episode_minutes !== "number") x.avg_episode_minutes = 45;
    }
  }

  saveLocalState();
}

function uniqKey(item){ return `${item.media_type}:${item.id}`; }
function minutesToHM(total){ return `${Math.floor(total/60)}h ${total%60}m`; }
function totalWatchedEpisodes(tvItem){
  const map = tvItem.seasons_watched || {};
  return Object.values(map).reduce((a,b)=>a+(Number(b)||0), 0);
}
function applySort(list, mode){
  const arr = [...list];
  if(mode === "title") arr.sort((a,b)=> (a.title||"").localeCompare(b.title||""));
  else arr.sort((a,b)=> (b.added_at||0) - (a.added_at||0));
  return arr;
}
function isInAnyList(media_type, id){
  const k = `${media_type}:${id}`;
  return state.watchlist.some(x=>uniqKey(x)===k) || state.watched.some(x=>uniqKey(x)===k);
}
function ratingToText(r){
  const n = Number(r);
  if(!Number.isFinite(n) || r === null) return "â€”";
  return "ğŸ¿".repeat(Math.max(1, Math.min(5, n)));
}

/* ===================== SUPABASE ===================== */
function canUseSupabase(){
  return !!(SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase && window.supabase.createClient);
}

async function initSync(){
  debug("initSync() started");
  migrate();

  if(!canUseSupabase()){
    setSyncStatus("Supabase not loaded");
    debug("Supabase JS missing");
    setLastSaved(null);
    renderAll();
    return;
  }

  sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  setSyncStatus("Connectingâ€¦");
  debug("Supabase client created");

  try{
    const { data, error } = await sb
      .from(SUPA_TABLE)
      .select("state, updated_at")
      .eq("id", SUPA_ID)
      .maybeSingle();

    if(error) throw error;

    if(data && data.state){
      state = data.state;
      migrate();
      setSyncStatus("Synced");
      debug("Loaded remote state");
      setLastSaved(data.updated_at);
    } else {
      const { error: upErr } = await sb
        .from(SUPA_TABLE)
        .upsert({ id: SUPA_ID, state }, { onConflict: "id" });
      if(upErr) throw upErr;
      setSyncStatus("Synced (created)");
      debug("Created remote state");
      setLastSaved(Date.now());
    }
  }catch(err){
    console.error(err);
    setSyncStatus("Sync error (using local)");
    debug("Sync error: " + (err?.message || String(err)));
  }

  renderAll();
}

function scheduleRemoteSave(){
  saveLocalState();
  if(!sb) return;

  setSyncStatus("Savingâ€¦");
  debug("Saving to Supabaseâ€¦");

  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(async ()=>{
    try{
      const { data, error } = await sb
        .from(SUPA_TABLE)
        .upsert({ id: SUPA_ID, state }, { onConflict: "id" })
        .select("updated_at")
        .single();

      if(error) throw error;
      setSyncStatus("Synced");
      debug("Saved to Supabase");
      setLastSaved(data.updated_at);
    }catch(err){
      console.error(err);
      setSyncStatus("Sync error (saved locally)");
      debug("Save error: " + (err?.message || String(err)));
    }
  }, 650);
}

/* ===================== TMDB ===================== */
async function tmdbFetch(path){
  const res = await fetch(`${TMDB_BASE}${path}`, {
    headers: { Authorization: `Bearer ${TMDB_BEARER}`, "Content-Type":"application/json;charset=utf-8" }
  });
  if(!res.ok) throw new Error(`TMDB ${res.status}`);
  return res.json();
}

/* ===================== TOP TAB NAV ===================== */
document.getElementById("topTabs").addEventListener("click", (e)=>{
  const t = e.target.closest(".topTab");
  if(!t) return;
  document.querySelectorAll(".topTab").forEach(x=>x.classList.toggle("active", x===t));
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(t.dataset.section).classList.add("active");
});

/* ===================== SEARCH UX ===================== */
document.getElementById("searchBtn").addEventListener("click", runSearch);
elSearchInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") runSearch(); });
document.getElementById("clearSearch").addEventListener("click", ()=>{
  elSearchInput.value = "";
  elResults.innerHTML = "";
  elSearchInput.focus();
});
elSearchInput.addEventListener("input", ()=>{
  if(elSearchInput.value.trim()==="") elResults.innerHTML = "";
});

/* ===================== SEARCH (AUTO TITLES + PEOPLE) ===================== */
async function runSearch(){
  const q = elSearchInput.value.trim();
  if(!q) return;

  elResults.innerHTML = `<div class="muted">Searchingâ€¦</div>`;

  try{
    const mode = elSearchMode.value;
    const type = elTypeFilter.value;

    const blocks = [];

    if(mode === "auto" || mode === "titles"){
      const data = await tmdbFetch(`/search/${type}?query=${encodeURIComponent(q)}&include_adult=false&language=en-US&page=1`);
      const results = (data.results||[])
        .filter(r => (r.media_type ? (r.media_type==="movie" || r.media_type==="tv") : true))
        .slice(0, 10);
      blocks.push(renderTitleResults(results, type));
    }

    if(mode === "auto" || mode === "people"){
      const p = await tmdbFetch(`/search/person?query=${encodeURIComponent(q)}&include_adult=false&language=en-US&page=1`);
      const people = (p.results||[]).slice(0, 10);
      blocks.push(renderPeopleResults(people));
    }

    elResults.innerHTML = blocks.filter(Boolean).join("");
    wireResultActions();
  }catch(err){
    elResults.innerHTML = `<div class="muted">Error: ${String(err.message||err)}</div>`;
  }
}

function yearFrom(r, media_type){
  return media_type === "movie"
    ? (r.release_date||"").slice(0,4)
    : (r.first_air_date||"").slice(0,4);
}

function renderTitleResults(results, type){
  const title = `<div class="muted" style="margin-top:4px;"><b>Titles</b></div>`;
  if(!results || results.length === 0) return `${title}<div class="muted">No titles found.</div>`;

  const items = results.map(r=>{
    const media_type = r.media_type || type;
    const name = media_type === "movie" ? r.title : r.name;
    const year = yearFrom(r, media_type);
    const poster = r.poster_path ? `${IMG_SMALL}${r.poster_path}` : "";
    const exists = isInAnyList(media_type, r.id);

    return `
      <div class="item" data-kind="title" data-id="${r.id}" data-media="${media_type}" data-name="${escapeHtml(name)}" data-year="${escapeHtml(year||"")}" data-poster="${escapeHtml(r.poster_path||"")}">
        <button class="posterBtn" data-open="details" aria-label="Open details">
          <img class="poster" src="${poster || ""}" alt="" onerror="this.style.display='none'">
        </button>
        <div>
          <div class="title" data-open="details">${escapeHtml(name)}</div>
          <div class="meta">${media_type.toUpperCase()} â€¢ ${escapeHtml(year||"â€”")} â€¢ TMDB: ${Number.isFinite(r.vote_average) ? r.vote_average.toFixed(1) : "â€”"}</div>
        </div>

        <button class="kebab" data-open="menu" aria-label="Menu">â‹®</button>
        <div class="menu" data-menu>
          <button data-act="details">Details</button>
          <button data-act="watchlist" ${exists ? "disabled":""}>+ Add to Watchlist</button>
          <button data-act="watched" ${exists ? "disabled":""}>âœ“ Mark Watched</button>
        </div>
      </div>
    `;
  }).join("");

  return `${title}<div class="results">${items}</div>`;
}

function renderPeopleResults(people){
  const title = `<div class="muted" style="margin-top:10px;"><b>People</b></div>`;
  if(!people || people.length === 0) return `${title}<div class="muted">No people found.</div>`;

  const items = people.map(p=>{
    const img = p.profile_path ? `${IMG_SMALL}${p.profile_path}` : "";
    const dept = p.known_for_department || "Person";
    const known = (p.known_for||[]).slice(0,3).map(x=>x.title||x.name).filter(Boolean).join(" â€¢ ");

    const isActor = state.people.actors.some(x=>x.id===p.id);
    const isDirector = state.people.directors.some(x=>x.id===p.id);

    return `
      <div class="item" data-kind="person" data-person-id="${p.id}" data-person-name="${escapeHtml(p.name||"")}" data-profile="${escapeHtml(p.profile_path||"")}">
        <button class="posterBtn" data-open="person" aria-label="Open person">
          <img class="poster" src="${img || ""}" alt="" onerror="this.style.display='none'">
        </button>
        <div>
          <div class="title" data-open="person">${escapeHtml(p.name||"â€”")}</div>
          <div class="meta">${escapeHtml(dept)}${known ? " â€¢ " + escapeHtml(known) : ""}</div>
        </div>

        <button class="kebab" data-open="menu" aria-label="Menu">â‹®</button>
        <div class="menu" data-menu>
          <button data-act="openPerson">View Filmography</button>
          <button data-act="followActor" ${isActor ? "disabled":""}>+ Follow as Actor</button>
          <button data-act="followDirector" ${isDirector ? "disabled":""}>+ Follow as Director</button>
        </div>
      </div>
    `;
  }).join("");

  return `${title}<div class="results">${items}</div>`;
}

/* ===================== RESULT EVENTS ===================== */
function wireResultActions(){
  document.addEventListener("click", closeAllMenus, { once:true });

  document.querySelectorAll(".item").forEach(card=>{
    const kebab = card.querySelector('[data-open="menu"]');
    const menu = card.querySelector("[data-menu]");
    if(kebab && menu){
      kebab.addEventListener("click", (e)=>{
        e.stopPropagation();
        const open = menu.style.display === "block";
        closeAllMenus();
        menu.style.display = open ? "none" : "block";
      });
    }

    card.querySelectorAll('[data-open="details"]').forEach(x=>x.addEventListener("click", async (e)=>{
      e.stopPropagation();
      if(card.dataset.kind !== "title") return;
      await openDetailsModalFromCard(card);
    }));

    card.querySelectorAll('[data-open="person"]').forEach(x=>x.addEventListener("click", async (e)=>{
      e.stopPropagation();
      if(card.dataset.kind !== "person") return;
      await openPersonModalFromCard(card);
    }));

    if(menu){
      menu.querySelectorAll("button").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          e.stopPropagation();
          menu.style.display="none";

          if(card.dataset.kind === "title"){
            const media_type = card.dataset.media;
            const id = Number(card.dataset.id);
            const title = card.dataset.name;
            const year = card.dataset.year || "";
            const poster_path = card.dataset.poster || "";

            if(btn.dataset.act === "details"){
              await openDetailsModalFromCard(card);
            } else if(btn.dataset.act === "watchlist"){
              addToWatchlist({ id, media_type, title, year, poster_path });
              renderAll();
            } else if(btn.dataset.act === "watched"){
              await addToWatchedFlow({ id, media_type, title, year, poster_path });
              renderAll();
            }
          }

          if(card.dataset.kind === "person"){
            const pid = Number(card.dataset.personId);
            const name = card.dataset.personName || "";
            const profile_path = card.dataset.profile || "";

            if(btn.dataset.act === "openPerson"){
              await openPersonModalFromCard(card);
            } else if(btn.dataset.act === "followActor"){
              if(!state.people.actors.some(x=>x.id===pid)){
                state.people.actors.unshift({ id: pid, name, profile_path, added_at: Date.now() });
                scheduleRemoteSave();
                renderAll();
              }
            } else if(btn.dataset.act === "followDirector"){
              if(!state.people.directors.some(x=>x.id===pid)){
                state.people.directors.unshift({ id: pid, name, profile_path, added_at: Date.now() });
                scheduleRemoteSave();
                renderAll();
              }
            }
          }
        });
      });
    }
  });
}

/* ===================== LIST ACTIONS ===================== */
function addToWatchlist(item){
  const k = uniqKey(item);
  if(state.watchlist.some(x=>uniqKey(x)===k) || state.watched.some(x=>uniqKey(x)===k)) return;
  state.watchlist.unshift({ ...item, added_at: Date.now() });
  scheduleRemoteSave();
}

async function addToWatchedFlow(item){
  const k = uniqKey(item);
  state.watchlist = state.watchlist.filter(x => uniqKey(x) !== k);

  if(item.media_type === "movie"){
    const details = await tmdbFetch(`/movie/${item.id}?language=en-US`);
    state.watched.unshift({
      ...item,
      runtime_minutes: details.runtime || 0,
      rating: null,
      added_at: Date.now()
    });
    scheduleRemoteSave();
    return;
  }

  const details = await tmdbFetch(`/tv/${item.id}?language=en-US`);
  const avgEp = Array.isArray(details.episode_run_time) && details.episode_run_time.length
    ? Math.round(details.episode_run_time.reduce((a,b)=>a+b,0) / details.episode_run_time.length)
    : 45;

  const seasons_meta = {};
  (details.seasons || [])
    .filter(s => typeof s.season_number === "number" && s.season_number > 0)
    .forEach(s => { seasons_meta[s.season_number] = s.episode_count || 0; });

  const tvItem = {
    ...item,
    avg_episode_minutes: avgEp,
    seasons_meta,
    seasons_watched: {},
    rating: null,
    added_at: Date.now()
  };

  if(seasons_meta[1] > 0) tvItem.seasons_watched[1] = 1;

  state.watched.unshift(tvItem);
  scheduleRemoteSave();
}

/* ===================== WATCHLIST/WATCHED UI ===================== */
document.getElementById("watchlistTabs").addEventListener("click", (e)=>{
  const tab = e.target.closest(".tab"); if(!tab) return;
  watchlistTab = tab.dataset.tab;
  document.querySelectorAll("#watchlistTabs .tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===watchlistTab));
  renderWatchlist();
});
document.getElementById("watchedTabs").addEventListener("click", (e)=>{
  const tab = e.target.closest(".tab"); if(!tab) return;
  watchedTab = tab.dataset.tab;
  document.querySelectorAll("#watchedTabs .tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===watchedTab));
  renderWatched();
});
document.getElementById("peopleTabs").addEventListener("click", (e)=>{
  const tab = e.target.closest(".tab"); if(!tab) return;
  peopleTab = tab.dataset.tab;
  document.querySelectorAll("#peopleTabs .tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===peopleTab));
  renderPeople();
});

document.getElementById("watchlistSort").addEventListener("change", (e)=>{ watchlistSort = e.target.value; renderWatchlist(); });
document.getElementById("watchedSort").addEventListener("change", (e)=>{ watchedSort = e.target.value; renderWatched(); });

function renderAll(){
  renderHome();
  renderWatchlist();
  renderWatched();
  renderPeople();
  renderTotals();
}

function renderHome(){
  const combined = []
    .concat(state.watchlist.map(x=>({ ...x, __list:"watchlist" })))
    .concat(state.watched.map(x=>({ ...x, __list:"watched" })))
    .sort((a,b)=>(b.added_at||0)-(a.added_at||0))
    .slice(0,5);

  if(combined.length === 0){
    elHomeRecent.innerHTML = `<div class="muted">Nothing yet. Add something using the Search tab.</div>`;
    return;
  }

  elHomeRecent.innerHTML = combined.map(item=>{
    const poster = item.poster_path ? (IMG_SMALL + item.poster_path) : "";
    const badge = item.__list === "watched" ? `âœ“ Watched` : `+ Watchlist`;
    const extra = item.__list === "watched" ? ` â€¢ Rating: ${ratingToText(item.rating)}` : ``;
    return `
      <div class="item" data-kind="title" data-id="${item.id}" data-media="${item.media_type}" data-name="${escapeHtml(item.title||"")}" data-year="${escapeHtml(item.year||"")}" data-poster="${escapeHtml(item.poster_path||"")}">
        <button class="posterBtn" data-open="details" aria-label="Open details">
          <img class="poster" src="${poster || ""}" alt="" onerror="this.style.display='none'">
        </button>
        <div>
          <div class="title" data-open="details">${escapeHtml(item.title||"â€”")}</div>
          <div class="meta">${badge} â€¢ ${escapeHtml(item.media_type.toUpperCase())} â€¢ ${escapeHtml(item.year||"â€”")}${extra}</div>
        </div>
        <button class="kebab" data-open="menu" aria-label="Menu">â‹®</button>
        <div class="menu" data-menu>
          <button data-act="details">Details</button>
          ${item.__list === "watchlist"
            ? `<button data-act="toWatched">âœ“ Mark Watched</button>`
            : `
              <button data-act="toWatchlist">â†© Move to Watchlist</button>
              <button data-act="rate:1">Rate: ğŸ¿</button>
              <button data-act="rate:2">Rate: ğŸ¿ğŸ¿</button>
              <button data-act="rate:3">Rate: ğŸ¿ğŸ¿ğŸ¿</button>
              <button data-act="rate:4">Rate: ğŸ¿ğŸ¿ğŸ¿ğŸ¿</button>
              <button data-act="rate:5">Rate: ğŸ¿ğŸ¿ğŸ¿ğŸ¿ğŸ¿</button>
              <button data-act="rate:clear">Rate: â€”</button>
            `
          }
          <button class="dangerItem" data-act="remove">Remove</button>
        </div>
      </div>
    `;
  }).join("");

  wireListCards(elHomeRecent, "home");
}

function renderWatchlist(){
  const list = applySort(state.watchlist.filter(i => i.media_type === watchlistTab), watchlistSort);
  if(list.length === 0){
    elWatchlistList.innerHTML = `<div class="muted">No ${watchlistTab === "movie" ? "movies" : "TV shows"} in watchlist.</div>`;
    return;
  }
  elWatchlistList.innerHTML = list.map(item => listCardHtml(item, "watchlist")).join("");
  wireListCards(elWatchlistList, "watchlist");
}

function renderWatched(){
  const list = applySort(state.watched.filter(i => i.media_type === watchedTab), watchedSort);
  if(list.length === 0){
    elWatchedList.innerHTML = `<div class="muted">No watched ${watchedTab === "movie" ? "movies" : "TV shows"} yet.</div>`;
    return;
  }
  elWatchedList.innerHTML = list.map(item => listCardHtml(item, "watched")).join("");
  wireListCards(elWatchedList, "watched");
}

function renderPeople(){
  const list = (peopleTab === "actors") ? state.people.actors : state.people.directors;
  if(list.length === 0){
    elPeopleList.innerHTML = `<div class="muted">No ${peopleTab} followed yet. Search a person and follow them.</div>`;
    return;
  }
  elPeopleList.innerHTML = list.map(p => `
    <div class="item" data-kind="followedPerson" data-person-id="${p.id}" data-person-name="${escapeHtml(p.name||"")}" data-profile="${escapeHtml(p.profile_path||"")}">
      <button class="posterBtn" data-open="person" aria-label="Open person">
        <img class="poster" src="${p.profile_path ? (IMG_SMALL + p.profile_path) : ""}" alt="" onerror="this.style.display='none'">
      </button>
      <div>
        <div class="title" data-open="person">${escapeHtml(p.name||"â€”")}</div>
        <div class="meta">Followed as ${peopleTab === "actors" ? "Actor" : "Director"}</div>
      </div>

      <button class="kebab" data-open="menu" aria-label="Menu">â‹®</button>
      <div class="menu" data-menu>
        <button data-act="openPerson">View Filmography</button>
        <button class="dangerItem" data-act="unfollow">Unfollow</button>
      </div>
    </div>
  `).join("");

  elPeopleList.querySelectorAll(".item").forEach(card=>{
    const kebab = card.querySelector('[data-open="menu"]');
    const menu = card.querySelector("[data-menu]");

    kebab.addEventListener("click", (e)=>{
      e.stopPropagation();
      const open = menu.style.display === "block";
      closeAllMenus();
      menu.style.display = open ? "none" : "block";
    });

    card.querySelectorAll('[data-open="person"]').forEach(x=>x.addEventListener("click", async (e)=>{
      e.stopPropagation();
      await openPersonModalFromCard(card);
    }));

    menu.querySelectorAll("button").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        e.stopPropagation();
        menu.style.display="none";
        const pid = Number(card.dataset.personId);

        if(btn.dataset.act === "openPerson"){
          await openPersonModalFromCard(card);
        } else if(btn.dataset.act === "unfollow"){
          if(peopleTab === "actors"){
            state.people.actors = state.people.actors.filter(x=>x.id!==pid);
          } else {
            state.people.directors = state.people.directors.filter(x=>x.id!==pid);
          }
          scheduleRemoteSave();
          renderPeople();
        }
      });
    });
  });

  document.addEventListener("click", closeAllMenus, { once:true });
}

function listCardHtml(item, listType){
  const poster = item.poster_path ? (IMG_SMALL + item.poster_path) : "";
  const year = item.year || "â€”";
  const subtitle =
    item.media_type === "movie"
      ? `${year}${typeof item.runtime_minutes === "number" ? " â€¢ " + item.runtime_minutes + " min" : ""}`
      : `${year} â€¢ ${totalWatchedEpisodes(item)} ep Ã— ${item.avg_episode_minutes || 0}m`;

  const ratingLine = (listType === "watched")
    ? `<div class="meta">Your rating: <b>${ratingToText(item.rating)}</b></div>`
    : ``;

  return `
    <div class="item" data-kind="title" data-id="${item.id}" data-media="${item.media_type}" data-name="${escapeHtml(item.title||"")}" data-year="${escapeHtml(item.year||"")}" data-poster="${escapeHtml(item.poster_path||"")}">
      <button class="posterBtn" data-open="details" aria-label="Open details">
        <img class="poster" src="${poster || ""}" alt="" onerror="this.style.display='none'">
      </button>
      <div>
        <div class="title" data-open="details">${escapeHtml(item.title||"â€”")}</div>
        <div class="meta">${subtitle}</div>
        ${ratingLine}
      </div>

      <button class="kebab" data-open="menu" aria-label="Menu">â‹®</button>
      <div class="menu" data-menu>
        <button data-act="details">Details</button>
        ${listType === "watchlist"
          ? `<button data-act="toWatched">âœ“ Mark Watched</button>`
          : `
            <button data-act="toWatchlist">â†© Move to Watchlist</button>
            <button data-act="rate:1">Rate: ğŸ¿</button>
            <button data-act="rate:2">Rate: ğŸ¿ğŸ¿</button>
            <button data-act="rate:3">Rate: ğŸ¿ğŸ¿ğŸ¿</button>
            <button data-act="rate:4">Rate: ğŸ¿ğŸ¿ğŸ¿ğŸ¿</button>
            <button data-act="rate:5">Rate: ğŸ¿ğŸ¿ğŸ¿ğŸ¿ğŸ¿</button>
            <button data-act="rate:clear">Rate: â€”</button>
          `
        }
        <button class="dangerItem" data-act="remove">Remove</button>
      </div>
    </div>
  `;
}

function wireListCards(container, listType){
  container.querySelectorAll(".item").forEach(card=>{
    const kebab = card.querySelector('[data-open="menu"]');
    const menu = card.querySelector("[data-menu]");

    if(kebab && menu){
      kebab.addEventListener("click", (e)=>{
        e.stopPropagation();
        const open = menu.style.display === "block";
        closeAllMenus();
        menu.style.display = open ? "none" : "block";
      });
    }

    card.querySelectorAll('[data-open="details"]').forEach(x=>x.addEventListener("click", async (e)=>{
      e.stopPropagation();
      await openDetailsModalFromCard(card);
    }));

    if(menu){
      menu.querySelectorAll("button").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          e.stopPropagation();
          menu.style.display="none";

          const media_type = card.dataset.media;
          const id = Number(card.dataset.id);
          const title = card.dataset.name;
          const year = card.dataset.year || "";
          const poster_path = card.dataset.poster || "";
          const k = `${media_type}:${id}`;

          if(btn.dataset.act === "details"){
            await openDetailsModalFromCard(card);
            return;
          }

          // âœ… rating actions MUST be handled before other branches
          if(btn.dataset.act && btn.dataset.act.startsWith("rate:")){
            const val = btn.dataset.act.split(":")[1];
            const w = state.watched.find(x => uniqKey(x) === k);
            if(w){
              w.rating = (val === "clear") ? null : Number(val);
              scheduleRemoteSave();
              renderAll();
            }
            return;
          }

          // watchlist actions
          if(state.watchlist.some(x=>uniqKey(x)===k)){
            if(btn.dataset.act === "toWatched"){
              await addToWatchedFlow({ id, media_type, title, year, poster_path });
            } else if(btn.dataset.act === "remove"){
              state.watchlist = state.watchlist.filter(x=>uniqKey(x)!==k);
            }
            scheduleRemoteSave();
            renderAll();
            return;
          }

          // watched actions
          if(state.watched.some(x=>uniqKey(x)===k)){
            if(btn.dataset.act === "toWatchlist"){
              state.watched = state.watched.filter(x=>uniqKey(x)!==k);
              state.watchlist.unshift({ id, media_type, title, year, poster_path, added_at: Date.now() });
            } else if(btn.dataset.act === "remove"){
              state.watched = state.watched.filter(x=>uniqKey(x)!==k);
            }
            scheduleRemoteSave();
            renderAll();
            return;
          }
        });
      });
    }
  });

  document.addEventListener("click", closeAllMenus, { once:true });
}

function renderTotals(){
  let movieMin = 0, tvMin = 0;
  for(const item of state.watched){
    if(item.media_type === "movie") movieMin += (item.runtime_minutes || 0);
    else tvMin += totalWatchedEpisodes(item) * (item.avg_episode_minutes || 0);
  }
  elTimeMovies.textContent = minutesToHM(movieMin);
  elTimeTV.textContent = minutesToHM(tvMin);
  elTimeTotal.textContent = minutesToHM(movieMin + tvMin);
}

/* ===================== DETAILS MODAL ===================== */
const detailsBackdrop = document.getElementById("detailsBackdrop");
const detailsPoster = document.getElementById("detailsPoster");
const detailsTitle = document.getElementById("detailsTitle");
const detailsMeta = document.getElementById("detailsMeta");
const detailsOverview = document.getElementById("detailsOverview");
const castCarousel = document.getElementById("castCarousel");
const dirCarousel = document.getElementById("dirCarousel");
const simCarousel = document.getElementById("simCarousel");

const btnDetailsClose = document.getElementById("detailsClose");
const btnDetailsWatchlist = document.getElementById("detailsAddWatchlist");
const btnDetailsWatched = document.getElementById("detailsAddWatched");
const detailsRating = document.getElementById("detailsRating");

let currentDetails = null;

btnDetailsClose.addEventListener("click", ()=>closeDetails());
detailsBackdrop.addEventListener("click", (e)=>{ if(e.target===detailsBackdrop) closeDetails(); });
window.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && detailsBackdrop.style.display==="flex") closeDetails(); });

function closeDetails(){
  detailsBackdrop.style.display = "none";
  document.body.style.overflow = "";
  currentDetails = null;
}

async function openDetailsModalFromCard(card){
  const media_type = card.dataset.media;
  const id = Number(card.dataset.id);
  const title = card.dataset.name;
  const year = card.dataset.year || "";
  const poster_path = card.dataset.poster || "";
  await openDetailsModal({ id, media_type, title, year, poster_path });
}

function syncDetailsRatingUI(media_type, id){
  const k = `${media_type}:${id}`;
  const w = state.watched.find(x=>uniqKey(x)===k);
  detailsRating.disabled = !w;
  detailsRating.value = w && w.rating ? String(w.rating) : "";
}

async function openDetailsModal(item){
  currentDetails = { ...item };
  document.body.style.overflow = "hidden";
  detailsBackdrop.style.display = "flex";

  detailsTitle.textContent = item.title || "â€”";
  detailsMeta.textContent = `${item.media_type.toUpperCase()} â€¢ ${item.year || "â€”"}`;
  detailsPoster.src = item.poster_path ? (IMG_POSTER + item.poster_path) : "";
  detailsOverview.textContent = "Loadingâ€¦";
  castCarousel.innerHTML = "";
  dirCarousel.innerHTML = "";
  simCarousel.innerHTML = "";

  const exists = isInAnyList(item.media_type, item.id);
  btnDetailsWatchlist.disabled = exists;
  btnDetailsWatched.disabled = exists;

  // rating dropdown: enabled only if already in watched
  syncDetailsRatingUI(item.media_type, item.id);

  btnDetailsWatchlist.onclick = ()=>{
    addToWatchlist(item);
    btnDetailsWatchlist.disabled = true;
    btnDetailsWatched.disabled = true;
    renderAll();
  };
  btnDetailsWatched.onclick = async ()=>{
    await addToWatchedFlow(item);
    btnDetailsWatchlist.disabled = true;
    btnDetailsWatched.disabled = true;
    // now rating becomes enabled (it exists in watched)
    syncDetailsRatingUI(item.media_type, item.id);
    renderAll();
  };

  detailsRating.onchange = ()=>{
    const k = `${item.media_type}:${item.id}`;
    const w = state.watched.find(x=>uniqKey(x)===k);
    if(!w) return;
    w.rating = detailsRating.value ? Number(detailsRating.value) : null;
    scheduleRemoteSave();
    renderAll();
  };

  try{
    const isMovie = item.media_type === "movie";
    const details = await tmdbFetch(`/${isMovie ? "movie" : "tv"}/${item.id}?language=en-US`);
    const credits = await tmdbFetch(`/${isMovie ? "movie" : "tv"}/${item.id}/credits?language=en-US`);
    const similar = await tmdbFetch(`/${isMovie ? "movie" : "tv"}/${item.id}/similar?language=en-US&page=1`);

    const runtime = isMovie ? (details.runtime || 0) : (Array.isArray(details.episode_run_time) && details.episode_run_time.length ? details.episode_run_time[0] : 0);
    const genres = (details.genres||[]).slice(0,4).map(g=>g.name).join(" â€¢ ");
    const score = Number.isFinite(details.vote_average) ? details.vote_average.toFixed(1) : "â€”";

    detailsMeta.textContent =
      `${item.media_type.toUpperCase()} â€¢ ${item.year || "â€”"} â€¢ TMDB ${score}${runtime ? " â€¢ " + runtime + "m" : ""}${genres ? " â€¢ " + genres : ""}`;

    detailsOverview.textContent = details.overview || "â€”";

    const cast = (credits.cast||[]).slice(0, 12);
    castCarousel.innerHTML = cast.length
      ? cast.map(p=>carPersonHtml(p)).join("")
      : `<div class="muted">No cast found.</div>`;

    const crew = credits.crew || [];
    const directors = crew.filter(c=>c.job === "Director").slice(0, 10);
    dirCarousel.innerHTML = directors.length
      ? directors.map(p=>carPersonHtml(p, true)).join("")
      : `<div class="muted">No directors found.</div>`;

    const sim = (similar.results||[]).filter(r => r.poster_path).slice(0, 12);
    simCarousel.innerHTML = sim.length
      ? sim.map(r=>{
          const mt = isMovie ? "movie" : "tv";
          const name = isMovie ? r.title : r.name;
          const yr = isMovie ? (r.release_date||"").slice(0,4) : (r.first_air_date||"").slice(0,4);
          return carTitleHtml({ id:r.id, media_type: mt, title:name, year:yr, poster_path:r.poster_path });
        }).join("")
      : `<div class="muted">No similar titles found.</div>`;

    castCarousel.querySelectorAll("[data-person]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const pid = Number(btn.dataset.person);
        const pname = btn.dataset.name || "";
        const pimg = btn.dataset.img || "";
        await openPersonFilmography(pid, pname, pimg);
      });
    });

    dirCarousel.querySelectorAll("[data-person]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const pid = Number(btn.dataset.person);
        const pname = btn.dataset.name || "";
        const pimg = btn.dataset.img || "";
        await openPersonFilmography(pid, pname, pimg);
      });
    });

    simCarousel.querySelectorAll("[data-title]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const tid = Number(btn.dataset.id);
        const mt = btn.dataset.media;
        const nm = btn.dataset.name || "";
        const yr = btn.dataset.year || "";
        const pp = btn.dataset.poster || "";
        await openDetailsModal({ id:tid, media_type:mt, title:nm, year:yr, poster_path:pp });
      });
    });

  }catch(err){
    console.error(err);
    detailsOverview.textContent = "Failed to load details. " + (err?.message || String(err));
  }
}

function carPersonHtml(p, isCrew=false){
  const img = p.profile_path ? (IMG_SMALL + p.profile_path) : "";
  const role = isCrew ? (p.job || "â€”") : (p.character || "â€”");
  return `
    <div class="carItem" data-person="${p.id}" data-name="${escapeHtml(p.name||"")}" data-img="${escapeHtml(p.profile_path||"")}" role="button" tabindex="0">
      <img class="carImg" src="${img || ""}" alt="" onerror="this.style.display='none'">
      <div class="carName">${escapeHtml(p.name||"â€”")}</div>
      <div class="carRole">${escapeHtml(role)}</div>
    </div>
  `;
}

function carTitleHtml(item){
  const img = item.poster_path ? (IMG_SMALL + item.poster_path) : "";
  return `
    <div class="carItem" data-title="1" data-id="${item.id}" data-media="${item.media_type}" data-name="${escapeHtml(item.title||"")}" data-year="${escapeHtml(item.year||"")}" data-poster="${escapeHtml(item.poster_path||"")}">
      <img class="carImg" src="${img || ""}" alt="" onerror="this.style.display='none'">
      <div class="carName">${escapeHtml(item.title||"â€”")}</div>
      <div class="carRole">${escapeHtml(item.media_type.toUpperCase())} â€¢ ${escapeHtml(item.year||"â€”")}</div>
    </div>
  `;
}

/* ===================== PERSON FILMOGRAPHY ===================== */
async function openPersonModalFromCard(card){
  const pid = Number(card.dataset.personId);
  const name = card.dataset.personName || "";
  const prof = card.dataset.profile || "";
  await openPersonFilmography(pid, name, prof);
}

async function openPersonFilmography(personId, name, profile_path){
  document.querySelectorAll(".topTab").forEach(t=>t.classList.toggle("active", t.dataset.section==="searchSec"));
  document.querySelectorAll(".section").forEach(s=>s.classList.toggle("active", s.id==="searchSec"));

  elResults.innerHTML = `<div class="muted">Loading filmography for <b>${escapeHtml(name||"Person")}</b>â€¦</div>`;

  try{
    const credits = await tmdbFetch(`/person/${personId}/combined_credits?language=en-US`);
    const all = []
      .concat((credits.cast||[]).map(x=>({ ...x, creditType:"Cast" })))
      .concat((credits.crew||[]).map(x=>({ ...x, creditType:(x.job||"Crew") })));

    const list = all
      .filter(x => (x.media_type==="movie" || x.media_type==="tv"))
      .filter(x => x.poster_path)
      .sort((a,b)=>(b.popularity||0)-(a.popularity||0))
      .slice(0, 30);

    const header = `
      <div class="card" style="margin-bottom:12px;">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div style="font-weight:950;font-size:20px;">${escapeHtml(name||"Person")}</div>
            <div class="muted">Top filmography (tap â‹® to add titles)</div>
          </div>
          <button id="backToSearch">Clear</button>
        </div>
      </div>
    `;

    const items = list.map(x=>{
      const media_type = x.media_type;
      const title = media_type==="movie" ? x.title : x.name;
      const year = media_type==="movie" ? (x.release_date||"").slice(0,4) : (x.first_air_date||"").slice(0,4);
      const exists = isInAnyList(media_type, x.id);

      return `
        <div class="item" data-kind="title" data-id="${x.id}" data-media="${media_type}" data-name="${escapeHtml(title||"")}" data-year="${escapeHtml(year||"")}" data-poster="${escapeHtml(x.poster_path||"")}">
          <button class="posterBtn" data-open="details" aria-label="Open details">
            <img class="poster" src="${IMG_SMALL}${x.poster_path}" alt="" onerror="this.style.display='none'">
          </button>
          <div>
            <div class="title" data-open="details">${escapeHtml(title||"â€”")}</div>
            <div class="meta">${media_type.toUpperCase()} â€¢ ${escapeHtml(year||"â€”")} â€¢ ${escapeHtml(x.creditType||"")}</div>
          </div>

          <button class="kebab" data-open="menu" aria-label="Menu">â‹®</button>
          <div class="menu" data-menu>
            <button data-act="details">Details</button>
            <button data-act="watchlist" ${exists ? "disabled":""}>+ Add to Watchlist</button>
            <button data-act="watched" ${exists ? "disabled":""}>âœ“ Mark Watched</button>
          </div>
        </div>
      `;
    }).join("");

    elResults.innerHTML = header + `<div class="results">${items}</div>`;
    document.getElementById("backToSearch").addEventListener("click", ()=>{ elResults.innerHTML=""; });

    wireResultActions();

  }catch(err){
    console.error(err);
    elResults.innerHTML = `<div class="muted">Failed to load filmography: ${escapeHtml(err?.message || String(err))}</div>`;
  }
}

/* ===================== HELPERS ===================== */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===================== START ===================== */
window.addEventListener("load", ()=>{
  try{
    initSync();
  }catch(e){
    console.error(e);
    setSyncStatus("JS error");
    debug("Startup error: " + (e?.message || String(e)));
  }
});
</script>
</body>
</html>
