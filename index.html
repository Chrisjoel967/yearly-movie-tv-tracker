<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Yearly Movie & TV Tracker</title>

<!-- ✅ SUPABASE (reliable CDN) -->
<script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:#0b0f17;
    color:#e8eefc;
  }
  .wrap{max-width:1100px;margin:auto;padding:20px;}
  h1{font-size:40px;margin-bottom:16px;}
  .card{
    background:#11182a;
    border:1px solid #23314f;
    border-radius:18px;
    padding:16px;
    margin-bottom:14px;
  }
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
  input,select,button{
    background:#0e1526;
    border:1px solid #2b3a5e;
    color:#e8eefc;
    border-radius:12px;
    padding:10px 12px;
    font-size:16px;
  }
  button{cursor:pointer;}
  .muted{color:#a9b7d6;font-size:14px;}
  .results{display:grid;gap:12px;margin-top:12px;}
  .item{
    display:grid;
    grid-template-columns:64px 1fr auto;
    gap:12px;
    background:#0f1729;
    border:1px solid #23314f;
    border-radius:14px;
    padding:12px;
    align-items:center;
  }
  .poster{width:64px;height:96px;border-radius:10px;background:#1b2640;object-fit:cover;}
  .title{font-size:20px;font-weight:800;}
</style>
</head>

<body>
<div class="wrap">
  <h1>Yearly Movie & TV Tracker</h1>

  <!-- SYNC STATUS -->
  <div class="card">
    <div class="row">
      <div class="muted">Sync status: <span id="syncStatus">Starting…</span></div>
      <div class="muted">Last saved: <span id="lastSaved">—</span></div>
    </div>
  </div>

  <!-- DEBUG -->
  <div class="card">
    <div class="muted" id="debugBox">Debug: —</div>
  </div>

  <!-- SEARCH -->
  <div class="card">
    <div class="row">
      <input id="searchInput" placeholder="Search movie or TV…" style="flex:1"/>
      <select id="typeFilter">
        <option value="multi">Movies + TV</option>
        <option value="movie">Movies only</option>
        <option value="tv">TV only</option>
      </select>
      <button id="searchBtn">Search</button>
    </div>
    <div id="results" class="results"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */

// TMDB (Read Access Token v4)
const TMDB_BEARER =
"eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJlOWY5NGVkYTNjMzFmMmQ2NWFjM2Y1OWNmMTBhN2VlNiIsIm5iZiI6MTc3MDUxMTY4MS4wNDQsInN1YiI6IjY5ODdkZDQxNjM5ZGJlZWQwNjhjOGQzYiIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.JjpO38-YZKSOX_PXz9zEYiW4zUDpTlFkwPf4XNIOB74";

const TMDB_BASE = "https://api.themoviedb.org/3";
const POSTER_BASE = "https://image.tmdb.org/t/p/w154";

// SUPABASE
const SUPABASE_URL = "https://bgnvmzvrmavzztplzlcg.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJnbnZtenZybWF2enp0cGx6bGNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NjA3MjEsImV4cCI6MjA4NDUzNjcyMX0.fBqfl2Mk8FX_epBwYJ7dBJl5SwyGQyjVfrfiKsrT-xc";

const SUPA_TABLE = "tracker_state";
const SUPA_ID = "main";

/* ================= STATE ================= */
const elSync = document.getElementById("syncStatus");
const elSaved = document.getElementById("lastSaved");
const elDebug = document.getElementById("debugBox");
const elResults = document.getElementById("results");

let supabase;
let state = { watchlist: [], watched: [] };

/* ================= HELPERS ================= */
function debug(msg){
  elDebug.textContent = "Debug: " + msg;
  console.log(msg);
}

async function tmdbFetch(path){
  const res = await fetch(TMDB_BASE + path, {
    headers:{
      Authorization: `Bearer ${TMDB_BEARER}`,
      accept: "application/json"
    }
  });
  const data = await res.json();
  if(!res.ok) throw new Error(data.status_message || res.status);
  return data;
}

/* ================= SUPABASE SYNC ================= */
async function initSync(){
  try{
    if(!window.supabase){
      elSync.textContent = "Supabase not loaded";
      debug("Supabase JS missing");
      return;
    }

    supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    );

    elSync.textContent = "Connecting…";

    const { data, error } = await supabase
      .from(SUPA_TABLE)
      .select("state, updated_at")
      .eq("id", SUPA_ID)
      .maybeSingle();

    if(error) throw error;

    if(data){
      state = data.state;
      elSaved.textContent = new Date(data.updated_at).toLocaleString();
      elSync.textContent = "Synced";
      debug("Loaded remote state");
    }else{
      await supabase.from(SUPA_TABLE).insert({ id: SUPA_ID, state });
      elSync.textContent = "Synced (created)";
      debug("Created new row");
    }

  }catch(err){
    elSync.textContent = "Sync error";
    debug(err.message);
  }
}

/* ================= SEARCH ================= */
document.getElementById("searchBtn").onclick = runSearch;
document.getElementById("searchInput").onkeydown =
  e => e.key === "Enter" && runSearch();

async function runSearch(){
  const q = searchInput.value.trim();
  if(!q) return;

  elResults.innerHTML = "<div class='muted'>Searching…</div>";
  try{
    const type = typeFilter.value;
    const data = await tmdbFetch(
      `/search/${type}?query=${encodeURIComponent(q)}`
    );

    elResults.innerHTML = "";
    data.results.slice(0,8).forEach(r=>{
      const title = r.title || r.name;
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        ${r.poster_path ? `<img class="poster" src="${POSTER_BASE}${r.poster_path}">` : `<div class="poster"></div>`}
        <div>
          <div class="title">${title}</div>
          <div class="muted">${r.media_type || type}</div>
        </div>
        <button>Add</button>
      `;
      elResults.appendChild(div);
    });
  }catch(err){
    elResults.innerHTML = `<div class="muted">Error: ${err.message}</div>`;
  }
}

/* ================= START ================= */
initSync();
</script>
</body>
</html>
